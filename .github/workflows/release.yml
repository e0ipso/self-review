# GitHub Actions Release Pipeline for self-review (Linux)
#
# Triggered when the CI workflow completes on main. Creates a GitHub Release
# with semantic-release and uploads .deb and .rpm packages as release assets.

name: Release (Linux)

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]

concurrency:
  group: release-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    permissions:
      actions: write
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      # workflow_run checkout by SHA creates detached HEAD.
      # semantic-release requires a named branch to match its config.
      - name: Restore branch ref for semantic-release
        run: git checkout -B ${{ github.event.workflow_run.head_branch }}

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - run: npm ci

      - name: Get tag before release
        id: before
        run: echo "tag=$(git describe --tags --abbrev=0 2>/dev/null || echo '')" >> "$GITHUB_OUTPUT"

      - name: Run semantic-release
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect new tag
        id: tag
        run: |
          git fetch --tags
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ "$TAG" != "${{ steps.before.outputs.tag }}" ] && [ -n "$TAG" ]; then
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          else
            echo "No new release tag created"
            echo "tag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Install Linux maker dependencies
        if: steps.tag.outputs.tag != ''
        run: sudo apt-get install -y dpkg-dev fakeroot rpm

      - name: Build Linux packages
        if: steps.tag.outputs.tag != ''
        run: npm run make

      - name: Upload release assets
        if: steps.tag.outputs.tag != ''
        run: gh release upload "${{ steps.tag.outputs.tag }}" out/make/deb/x64/*.deb out/make/rpm/x64/*.rpm --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger macOS build
        if: steps.tag.outputs.tag != ''
        run: gh workflow run release-darwin.yml -f tag="${{ steps.tag.outputs.tag }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

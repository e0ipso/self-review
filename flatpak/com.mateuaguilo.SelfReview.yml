# Flatpak manifest for Self Review
# Based on the Electron BaseApp template for Flathub:
#   https://github.com/nickvdp/chromium-flatpak-base-app (Electron2.BaseApp)
#   https://docs.flathub.org/docs/for-app-authors/requirements
#   https://docs.flathub.org/docs/for-app-authors/electron
app-id: com.mateuaguilo.SelfReview
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: '24.08'
command: self-review
separate-locales: false

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
  - --filesystem=host:ro
  - --talk-name=org.freedesktop.Notifications

modules:
  - name: self-review
    buildsystem: simple
    build-commands:
      - ar x self-review.deb
      - tar xf data.tar.*
      - cp -r usr/share/self-review /app/lib/self-review
      - install -Dm644 com.mateuaguilo.SelfReview.desktop /app/share/applications/com.mateuaguilo.SelfReview.desktop
      - install -Dm644 com.mateuaguilo.SelfReview.metainfo.xml /app/share/metainfo/com.mateuaguilo.SelfReview.metainfo.xml
      - install -Dm644 com.mateuaguilo.SelfReview.svg /app/share/icons/hicolor/scalable/apps/com.mateuaguilo.SelfReview.svg
      - install -Dm755 self-review.sh /app/bin/self-review
    sources:
      # sha256 values must be replaced with actual checksums before Flathub submission.
      # Compute with: sha256sum <filename>
      - type: file
        url: https://github.com/e0ipso/self-review/releases/download/v1.8.0/self-review_1.8.0_amd64.deb
        sha256: FIXME_REPLACE_WITH_ACTUAL_SHA256
        dest-filename: self-review.deb
        x-checker-data:
          type: json
          url: https://api.github.com/repos/e0ipso/self-review/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: .assets[] | select(.name | test("amd64\\.deb$")) | .browser_download_url
      - type: file
        path: com.mateuaguilo.SelfReview.desktop
      - type: file
        path: com.mateuaguilo.SelfReview.metainfo.xml
      # sha256 must be replaced with actual checksum before Flathub submission.
      - type: file
        url: https://raw.githubusercontent.com/e0ipso/self-review/main/assets/icon.svg
        sha256: FIXME_REPLACE_WITH_ACTUAL_SHA256
        dest-filename: com.mateuaguilo.SelfReview.svg
      - type: script
        dest-filename: self-review.sh
        commands:
          - export TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID"
          - exec zypak-wrapper /app/lib/self-review/self-review "$@"
